version: '3.8'

# FinOptiAgents Platform - Docker Compose Configuration
# 
# This file orchestrates all services in the FinOptiAgents platform:
# - Etcd: Key-value store for APISIX
# - Apache APISIX: API Gateway for routing and observability
# - OPA: Open Policy Agent for RBAC
# - Orchestrator: Central hub for request routing
# - Sub-Agents: GCloud and Monitoring agents
# - MCP Servers: Mock servers for tool execution
# - Streamlit UI: Frontend interface

services:
  # ====================
  # Etcd - APISIX Backend
  # ====================
  etcd:
    image: gcr.io/etcd-development/etcd:v3.5.0
    container_name: finopti-etcd
    environment:
      ETCD_ENABLE_V2: "true"
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ADVERTISE_CLIENT_URLS: "http://etcd:2379"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
    ports:
      - "2379:2379"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Apache APISIX - API Gateway
  # ====================
  apisix:
    image: apache/apisix:3.7.0-debian
    container_name: finopti-apisix
    volumes:
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro
    ports:
      - "9080:9080"  # HTTP port
      - "9180:9180"  # Admin API
      - "9191:9091"  # Prometheus metrics
    networks:
      - finopti-net
    depends_on:
      etcd:
        condition: service_healthy
    environment:
      APISIX_STAND_ALONE: "false"
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/9080"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ====================
  # APISIX Dashboard (Optional)
  # ====================
  apisix-dashboard:
    image: apache/apisix-dashboard:3.0.1-alpine
    container_name: finopti-apisix-dashboard
    ports:
      - "9000:9000"
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      APISIX_LISTEN_HOST: "apisix"

  # ====================
  # APISIX Route Initializer
  # ====================
  apisix-init:
    image: curlimages/curl:latest
    container_name: finopti-apisix-init
    volumes:
      - ./apisix_conf/init_routes.sh:/init_routes.sh:ro
    networks:
      - finopti-net
    depends_on:
      apisix:
        condition: service_healthy
    command: sh /init_routes.sh
    restart: "no"

  # ====================
  # OPA - Open Policy Agent
  # ====================
  opa:
    image: openpolicyagent/opa:latest
    container_name: finopti-opa
    volumes:
      - ./opa_policy:/policies:ro
    ports:
      - "8181:8181"
    networks:
      - finopti-net
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "/policies"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Orchestrator Agent (ADK)
  # ====================
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator_adk/Dockerfile
    container_name: finopti-orchestrator
    # ports:
    #   - "15000:5000" # Mesh enforcement: Only accessible via APISIX
    networks:
      - finopti-net
    depends_on:
      - opa
      - apisix
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      OPA_URL: "http://opa:8181"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      BQ_ANALYTICS_DATASET: "${BQ_ANALYTICS_DATASET}"
      BQ_ANALYTICS_TABLE: "${BQ_ANALYTICS_TABLE}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      REFLECT_RETRY_THROW_ON_FAIL: "${REFLECT_RETRY_THROW_ON_FAIL}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # GCloud Agent (ADK)
  # ====================
  gcloud_agent:
    build:
      context: .
      dockerfile: sub_agents/gcloud_agent_adk/Dockerfile
    container_name: finopti-gcloud-agent
    # ports:
    #   - "15001:5001" # Mesh enforcement: Only accessible via APISIX
    networks:
      - finopti-net
    depends_on:
      - apisix
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      GCLOUD_MCP_DOCKER_IMAGE: "finopti-gcloud-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      BQ_ANALYTICS_DATASET: "${BQ_ANALYTICS_DATASET}"
      BQ_ANALYTICS_TABLE: "${BQ_ANALYTICS_TABLE}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      REFLECT_RETRY_THROW_ON_FAIL: "${REFLECT_RETRY_THROW_ON_FAIL}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Monitoring Agent (ADK)
  # ====================
  monitoring_agent:
    build:
      context: .
      dockerfile: sub_agents/monitoring_agent_adk/Dockerfile
    container_name: finopti-monitoring-agent
    # ports:
    #   - "15002:5002" # Mesh enforcement: Only accessible via APISIX
    networks:
      - finopti-net
    depends_on:
      - apisix
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      MONITORING_MCP_DOCKER_IMAGE: "finopti-monitoring-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      BQ_ANALYTICS_TABLE: "${BQ_ANALYTICS_TABLE}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      REFLECT_RETRY_THROW_ON_FAIL: "${REFLECT_RETRY_THROW_ON_FAIL}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # GCloud MCP Server
  # ====================

  gcloud_mcp:
    image: finopti-gcloud-mcp
    build:
      context: temp_mcp_repo/gcloud-mcpserver/remote-mcp-server/gcloud-mcp-server
      dockerfile: Dockerfile
    container_name: finopti-gcloud-mcp
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:rw 
    ports:
      # Expose port even though agents mostly use stdio spawning from image, 
      # this allows manual testing via SSE if needed in future or testing build
      - "6001:6001"
    networks:
      - finopti-net
    healthcheck:
      # Check if process is running (npx/node)
      test: ["CMD", "pgrep", "node"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Monitoring MCP Server
  # ====================
  monitoring_mcp:
    image: finopti-monitoring-mcp
    build:
      context: temp_mcp_repo/gcloud-mcpserver/remote-mcp-server/gcloud-monitoring-mcp
      dockerfile: Dockerfile
    container_name: finopti-monitoring-mcp
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:rw
    ports:
      - "6002:6002"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "pgrep", "python"]

      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Loki - Log Aggregation
  # ====================
  loki:
    image: grafana/loki:2.9.3
    container_name: finopti-loki
    volumes:
      - loki-data:/loki
      - ./observability/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
    ports:
      - "3100:3100"
    networks:
      - finopti-net
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Promtail - Log Collector
  # ====================
  promtail:
    image: grafana/promtail:3.0.0
    container_name: finopti-promtail
    volumes:
      - ./observability/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - finopti-net
    depends_on:
      - loki
    command: -config.file=/etc/promtail/config.yml

  # ====================
  # Grafana - Visualization
  # ====================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: finopti-grafana
    ports:
      - "3001:3000"
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    networks:
      - finopti-net
    depends_on:
      - loki
      - apisix
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_LOG_LEVEL: info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Arize Phoenix - LLM Observability
  # ====================
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: finopti-phoenix
    ports:
      - "6006:6006" # UI
      - "4317:4317" # OTLP GRPC
    environment:
      - PHOENIX_SQL_DATABASE_URL=postgresql://postgres:postgres@db_postgres:5432/postgres
    depends_on:
      - db_postgres
    networks:
      - finopti-net

  # ====================
  # Streamlit UI
  # ====================
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: finopti-ui
    ports:
      - "8501:8501"
    networks:
      - finopti-net
    depends_on:
      - apisix
      - orchestrator
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
    environment:
      APISIX_URL: "http://apisix:9080"
      USE_SECRET_MANAGER: "true"
      GOOGLE_CLOUD_PROJECT: "vector-search-poc"
      GOOGLE_PROJECT_ID: "vector-search-poc"
      # Optional fallback OAuth env vars (not used when Secret Manager is enabled)
      GOOGLE_OAUTH_CLIENT_ID: "${GOOGLE_OAUTH_CLIENT_ID}"
      GOOGLE_OAUTH_CLIENT_SECRET: "${GOOGLE_OAUTH_CLIENT_SECRET}"
      GOOGLE_OAUTH_REDIRECT_URI: "${GOOGLE_OAUTH_REDIRECT_URI}"

  # ====================
  # NEW AGENTS & MCP SERVERS
  # ====================

  # --- GitHub Agent ---
  github_agent:
    build:
      context: .
      dockerfile: sub_agents/github_agent_adk/Dockerfile
    container_name: finopti-github-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      GITHUB_MCP_DOCKER_IMAGE: "finopti-github-mcp"
      GITHUB_PERSONAL_ACCESS_TOKEN: "${GITHUB_PERSONAL_ACCESS_TOKEN}"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # GitHub MCP (Optional build service, agents spawn it, but good to have definition)
  github_mcp:
    image: finopti-github-mcp
    build:
      context: temp_mcp_repo/github-mcp-server
      dockerfile: Dockerfile
    container_name: finopti-github-mcp
    networks:
      - finopti-net
    ports:
      - "6003:6003" # Debug port

  # --- Storage Agent ---
  storage_agent:
    build:
      context: .
      dockerfile: sub_agents/storage_agent_adk/Dockerfile
    container_name: finopti-storage-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      STORAGE_MCP_DOCKER_IMAGE: "finopti-storage-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Storage MCP (Optional build service)
  storage_mcp:
    image: finopti-storage-mcp
    build:
      context: temp_mcp_repo/gcloud-mcpserver/remote-mcp-server/google-storage-mcp
      dockerfile: Dockerfile
    container_name: finopti-storage-mcp
    networks:
      - finopti-net
    ports:
      - "6004:6004" # Debug port

  # --- Database Agent ---
  db_agent:
    build:
      context: .
      dockerfile: sub_agents/db_agent_adk/Dockerfile
    container_name: finopti-db-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
      - db_mcp_toolbox
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
      DB_MCP_TOOLBOX_URL: "http://db_mcp_toolbox:5000/mcp"
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Database Toolbox (Core Server) - Requires Postgres
  db_mcp_toolbox:
    image: us-central1-docker.pkg.dev/database-toolbox/toolbox/toolbox:0.22.0
    container_name: finopti-db-mcp-toolbox
    hostname: toolbox
    ports:
      - "6005:5000"
    volumes:
      - ./config/tools.yaml:/config/tools.yaml # Needs config file
    command: ["toolbox", "--tools-file", "/config/tools.yaml", "--address", "0.0.0.0"]
    depends_on:
      db_postgres:
        condition: service_healthy
    networks:
      - finopti-net

  # Postgres for DB Toolbox
  db_postgres:
    image: postgres:16-alpine
    container_name: finopti-db-postgres
    hostname: db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
        - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - finopti-net

  # --- Cloud Run Agent ---
  cloud_run_agent:
    build:
      context: .
      dockerfile: sub_agents/cloud_run_agent_adk/Dockerfile
    container_name: finopti-cloud-run-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      CLOUD_RUN_MCP_DOCKER_IMAGE: "finopti-cloud-run-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Brave Search Agent ---
  brave_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/brave_search_agent_adk/Dockerfile
    container_name: finopti-brave-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
      # Brave API Key handled by Secret Manager logic in agent, but passing env just in case we switch
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Filesystem Agent ---
  filesystem_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/filesystem_agent_adk/Dockerfile
    container_name: finopti-filesystem-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
      - FILESYSTEM_MCP_IMAGE=finopti-filesystem-mcp
      - FILESYSTEM_ROOT=/tmp/agent_filesystem
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
      # Bind mount for the safe fs operation
      - /tmp/agent_filesystem:/tmp/agent_filesystem
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5007/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Filesystem MCP Server
  filesystem_mcp:
    image: finopti-filesystem-mcp
    build:
      context: temp_mcp_repo/filesystem
      dockerfile: Dockerfile
    container_name: finopti-filesystem-mcp
    networks:
      - finopti-net
    ports:
      - "6007:6007" # Debug port

  # --- Analytics Agent ---
  analytics_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/analytics_agent_adk/Dockerfile
    container_name: finopti-analytics-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5008/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Puppeteer Agent ---
  puppeteer_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/puppeteer_agent_adk/Dockerfile
    container_name: finopti-puppeteer-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5009/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Puppeteer MCP Server
  puppeteer_mcp:
    image: finopti-puppeteer
    build:
      context: temp_mcp_repo/puppeteer
      dockerfile: Dockerfile
    container_name: finopti-puppeteer
    networks:
      - finopti-net
    # No ports needed as it's stdio-based usually, but expose for consistency/healthcheck if it had http
    # But stdio server doesn't expose http healthcheck
    # We can rely on container running
    command: [] 

  # ====================
  # Sequential Thinking MCP Server
  # ====================
  sequential_thinking_mcp:
    image: sequentialthinking
    build:
      context: temp_mcp_repo/sequentialthinking
      dockerfile: Dockerfile
    container_name: finopti-sequential-thinking-mcp
    networks:
      - finopti-net
    # No ports needed as it's stdio-based, agents spawn it dynamically
    command: []

  # --- Sequential Thinking Agent ---
  sequential_thinking_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/sequential_thinking_agent_adk/Dockerfile
    container_name: finopti-sequential-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5010/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Google Search Agent ---
  googlesearch_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/googlesearch_agent_adk/Dockerfile
    container_name: finopti-googlesearch-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
      - BQ_ANALYTICS_TABLE=${BQ_ANALYTICS_TABLE}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5011/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Code Execution Agent ---
  code_execution_agent_adk:
    build:
      context: .
      dockerfile: sub_agents/code_execution_agent_adk/Dockerfile
    container_name: finopti-code-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      - GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - APISIX_URL=http://apisix:9080
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - FINOPTIAGENTS_LLM=${FINOPTIAGENTS_LLM:-gemini-2.0-flash}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5012/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Cloud Run MCP (Optional build service)
  cloud_run_mcp:
    image: finopti-cloud-run-mcp
    build:
      context: temp_mcp_repo/gcloud-mcpserver/remote-mcp-server/google-cloud-run-mcp
      dockerfile: Dockerfile
    container_name: finopti-cloud-run-mcp
    networks:
      - finopti-net
    ports:
      - "6006:6006" # Debug port

  # ==========================================
  # MATS (Multimodal Autonomous Troubleshooting System)
  # ==========================================
  
  mats-sre-agent:
    build:
      context: .
      dockerfile: mats-agents/mats-sre-agent/Dockerfile
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}

      - GCLOUD_MCP_DOCKER_IMAGE=finopti-gcloud-mcp
      - MONITORING_MCP_DOCKER_IMAGE=finopti-monitoring-mcp
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
      - PYTHONUNBUFFERED=1
      - GCLOUD_MOUNT_PATH=${HOME}/.config/gcloud:/root/.config/gcloud
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    ports:
      - "8081:8081"
    networks:
      - finopti-net
    labels:
      - "com.docker.compose.project=finopti-platform"
      - "service=mats-sre-agent"
    deploy:
      resources:
        limits:
          memory: 512M

  mats-investigator-agent:
    build:
      context: .
      dockerfile: mats-agents/mats-investigator-agent/Dockerfile
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}

      - GITHUB_MCP_DOCKER_IMAGE=finopti-github-mcp-server
      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
      - PYTHONUNBUFFERED=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    ports:
      - "8082:8082"
    networks:
      - finopti-net
    labels:
      - "com.docker.compose.project=finopti-platform"
      - "service=mats-investigator-agent"
    deploy:
      resources:
        limits:
          memory: 512M

  mats-architect-agent:
    build:
      context: .
      dockerfile: mats-agents/mats-architect-agent/Dockerfile
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}

      - BQ_ANALYTICS_ENABLED=${BQ_ANALYTICS_ENABLED}
      - PYTHONUNBUFFERED=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    ports:
      - "8083:8083"
    networks:
      - finopti-net
    labels:
      - "com.docker.compose.project=finopti-platform"
      - "service=mats-architect-agent"
    deploy:
      resources:
        limits:
          memory: 512M

  mats-orchestrator:
    build:
      context: .
      dockerfile: mats-agents/mats-orchestrator/Dockerfile
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - PYTHONUNBUFFERED=1
      # Observability
      - PHOENIX_COLLECTOR_ENDPOINT=${PHOENIX_COLLECTOR_ENDPOINT:-http://phoenix:6006/v1/traces}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://phoenix:4317}
      # Internal Service URLs for networking
      - SRE_AGENT_URL=http://mats-sre-agent:8081
      - INVESTIGATOR_AGENT_URL=http://mats-investigator-agent:8082
      - ARCHITECT_AGENT_URL=http://mats-architect-agent:8083
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    ports:
      - "8084:8084"
    networks:
      - finopti-net
    labels:
      - "com.docker.compose.project=finopti-platform"
      - "service=mats-orchestrator"
    deploy:
      resources:
        limits:
          memory: 256M

  # ==========================================
  # Chaos Monkey Application
  # ==========================================
  
  monkey_agent:
    build:
      context: ../chaos-monkey-testing/monkey_agent
      dockerfile: Dockerfile
    container_name: monkey_agent
    environment:
      - ORCHESTRATOR_URL=http://apisix:9080/orchestrator/ask
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    ports:
      - "5007:5007"
    networks:
      - finopti-net
    labels:
      - "com.docker.compose.project=finopti-platform"
      - "service=monkey_agent"

  monkey_ui:
    build:
      context: ../chaos-monkey-testing/monkey_ui
      dockerfile: Dockerfile
    container_name: monkey_ui
    ports:
      - "8088:80"
    networks:
      - finopti-net
    labels:
      - "com.docker.compose.project=finopti-platform"
      - "service=monkey_ui"

# ====================
# Volume Configuration
# ====================
volumes:
  postgres-data:
    name: finopti-postgres-data
  loki-data:
    name: finopti-loki-data
  grafana-data:
    name: finopti-grafana-data

# ====================
# Network Configuration
# ====================
networks:
  finopti-net:
    name: finopti-net
    driver: bridge
