version: '3.8'

# FinOptiAgents Platform - Docker Compose Configuration
# 
# This file orchestrates all services in the FinOptiAgents platform:
# - Etcd: Key-value store for APISIX
# - Apache APISIX: API Gateway for routing and observability
# - OPA: Open Policy Agent for RBAC
# - Orchestrator: Central hub for request routing
# - Sub-Agents: GCloud and Monitoring agents
# - MCP Servers: Mock servers for tool execution
# - Streamlit UI: Frontend interface

services:
  # ====================
  # Etcd - APISIX Backend
  # ====================
  etcd:
    image: gcr.io/etcd-development/etcd:v3.5.0
    container_name: finopti-etcd
    environment:
      ETCD_ENABLE_V2: "true"
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ADVERTISE_CLIENT_URLS: "http://etcd:2379"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
    ports:
      - "2379:2379"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Apache APISIX - API Gateway
  # ====================
  apisix:
    image: apache/apisix:3.7.0-debian
    container_name: finopti-apisix
    volumes:
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro
    ports:
      - "9080:9080"  # HTTP port
      - "9180:9180"  # Admin API
      - "9191:9091"  # Prometheus metrics
    networks:
      - finopti-net
    depends_on:
      etcd:
        condition: service_healthy
    environment:
      APISIX_STAND_ALONE: "false"
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/9080"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ====================
  # APISIX Dashboard (Optional)
  # ====================
  apisix-dashboard:
    image: apache/apisix-dashboard:3.0.1-alpine
    container_name: finopti-apisix-dashboard
    ports:
      - "9000:9000"
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      APISIX_LISTEN_HOST: "apisix"

  # ====================
  # APISIX Route Initializer
  # ====================
  apisix-init:
    image: curlimages/curl:latest
    container_name: finopti-apisix-init
    volumes:
      - ./apisix_conf/init_routes.sh:/init_routes.sh:ro
    networks:
      - finopti-net
    depends_on:
      apisix:
        condition: service_healthy
    command: sh /init_routes.sh
    restart: "no"

  # ====================
  # OPA - Open Policy Agent
  # ====================
  opa:
    image: openpolicyagent/opa:latest
    container_name: finopti-opa
    volumes:
      - ./opa_policy:/policies:ro
    ports:
      - "8181:8181"
    networks:
      - finopti-net
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "/policies"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Orchestrator Agent (ADK)
  # ====================
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator_adk/Dockerfile
    container_name: finopti-orchestrator
    # ports:
    #   - "15000:5000" # Mesh enforcement: Only accessible via APISIX
    networks:
      - finopti-net
    depends_on:
      - opa
      - apisix
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      OPA_URL: "http://opa:8181"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      BQ_ANALYTICS_DATASET: "${BQ_ANALYTICS_DATASET}"
      BQ_ANALYTICS_TABLE: "${BQ_ANALYTICS_TABLE}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      REFLECT_RETRY_THROW_ON_FAIL: "${REFLECT_RETRY_THROW_ON_FAIL}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # GCloud Agent (ADK)
  # ====================
  gcloud_agent:
    build:
      context: .
      dockerfile: sub_agents/gcloud_agent_adk/Dockerfile
    container_name: finopti-gcloud-agent
    # ports:
    #   - "15001:5001" # Mesh enforcement: Only accessible via APISIX
    networks:
      - finopti-net
    depends_on:
      - apisix
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      GCLOUD_MCP_DOCKER_IMAGE: "finopti-gcloud-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      BQ_ANALYTICS_DATASET: "${BQ_ANALYTICS_DATASET}"
      BQ_ANALYTICS_TABLE: "${BQ_ANALYTICS_TABLE}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      REFLECT_RETRY_THROW_ON_FAIL: "${REFLECT_RETRY_THROW_ON_FAIL}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Monitoring Agent (ADK)
  # ====================
  monitoring_agent:
    build:
      context: .
      dockerfile: sub_agents/monitoring_agent_adk/Dockerfile
    container_name: finopti-monitoring-agent
    # ports:
    #   - "15002:5002" # Mesh enforcement: Only accessible via APISIX
    networks:
      - finopti-net
    depends_on:
      - apisix
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      MONITORING_MCP_DOCKER_IMAGE: "finopti-monitoring-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      BQ_ANALYTICS_TABLE: "${BQ_ANALYTICS_TABLE}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
      REFLECT_RETRY_THROW_ON_FAIL: "${REFLECT_RETRY_THROW_ON_FAIL}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # GCloud MCP Server
  # ====================
  # GCloud MCP Server
  # ====================
  # GCloud MCP Server
  # ====================
  gcloud_mcp:
    image: finopti-gcloud-mcp
    container_name: finopti-gcloud-mcp
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:rw 
    ports:
      # Expose port even though agents mostly use stdio spawning from image, 
      # this allows manual testing via SSE if needed in future or testing build
      - "6001:6001"
    networks:
      - finopti-net
    healthcheck:
      # Check if process is running (npx/node)
      test: ["CMD", "pgrep", "node"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Monitoring MCP Server
  # ====================
  monitoring_mcp:
    image: finopti-monitoring-mcp
    container_name: finopti-monitoring-mcp
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:rw
    ports:
      - "6002:6002"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "pgrep", "python"]

      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Loki - Log Aggregation
  # ====================
  loki:
    image: grafana/loki:2.9.3
    container_name: finopti-loki
    volumes:
      - loki-data:/loki
      - ./observability/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
    ports:
      - "3100:3100"
    networks:
      - finopti-net
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Promtail - Log Collector
  # ====================
  promtail:
    image: grafana/promtail:3.0.0
    container_name: finopti-promtail
    volumes:
      - ./observability/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - finopti-net
    depends_on:
      - loki
    command: -config.file=/etc/promtail/config.yml

  # ====================
  # Grafana - Visualization
  # ====================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: finopti-grafana
    ports:
      - "3001:3000"
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    networks:
      - finopti-net
    depends_on:
      - loki
      - apisix
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_LOG_LEVEL: info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Streamlit UI
  # ====================
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: finopti-ui
    ports:
      - "8501:8501"
    networks:
      - finopti-net
    depends_on:
      - apisix
      - orchestrator
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
    environment:
      APISIX_URL: "http://apisix:9080"
      USE_SECRET_MANAGER: "true"
      GOOGLE_CLOUD_PROJECT: "vector-search-poc"
      GOOGLE_PROJECT_ID: "vector-search-poc"
      # Optional fallback OAuth env vars (not used when Secret Manager is enabled)
      GOOGLE_OAUTH_CLIENT_ID: "${GOOGLE_OAUTH_CLIENT_ID}"
      GOOGLE_OAUTH_CLIENT_SECRET: "${GOOGLE_OAUTH_CLIENT_SECRET}"
      GOOGLE_OAUTH_REDIRECT_URI: "${GOOGLE_OAUTH_REDIRECT_URI}"

  # ====================
  # NEW AGENTS & MCP SERVERS
  # ====================

  # --- GitHub Agent ---
  github_agent:
    build:
      context: .
      dockerfile: sub_agents/github_agent_adk/Dockerfile
    container_name: finopti-github-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      GITHUB_MCP_DOCKER_IMAGE: "finopti-github-mcp"
      GITHUB_PERSONAL_ACCESS_TOKEN: "${GITHUB_PERSONAL_ACCESS_TOKEN}"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
      REFLECT_RETRY_MAX_ATTEMPTS: "${REFLECT_RETRY_MAX_ATTEMPTS}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # GitHub MCP (Optional build service, agents spawn it, but good to have definition)
  github_mcp:
    image: finopti-github-mcp
    container_name: finopti-github-mcp
    networks:
      - finopti-net
    ports:
      - "6003:6003" # Debug port

  # --- Storage Agent ---
  storage_agent:
    build:
      context: .
      dockerfile: sub_agents/storage_agent_adk/Dockerfile
    container_name: finopti-storage-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      STORAGE_MCP_DOCKER_IMAGE: "finopti-storage-mcp"
      GCLOUD_MOUNT_PATH: "${HOME}/.config/gcloud:/root/.config/gcloud"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
    volumes:
      - ~/.config/gcloud:/root/.config/gcloud:ro
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Storage MCP (Optional build service)
  storage_mcp:
    image: finopti-storage-mcp
    container_name: finopti-storage-mcp
    networks:
      - finopti-net
    ports:
      - "6004:6004" # Debug port

  # --- Database Agent ---
  db_agent:
    build:
      context: .
      dockerfile: sub_agents/db_agent_adk/Dockerfile
    container_name: finopti-db-agent
    networks:
      - finopti-net
    depends_on:
      - apisix
      - db_mcp_toolbox
    environment:
      GOOGLE_CLOUD_PROJECT: "${GCP_PROJECT_ID}"
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      DB_MCP_TOOLBOX_URL: "http://db_mcp_toolbox:5000"
      APISIX_URL: "http://apisix:9080"
      BQ_ANALYTICS_ENABLED: "${BQ_ANALYTICS_ENABLED}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.config/gcloud:/root/.config/gcloud:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Database Toolbox (Core Server) - Requires Postgres
  db_mcp_toolbox:
    image: us-central1-docker.pkg.dev/database-toolbox/toolbox/toolbox:0.22.0
    container_name: finopti-db-mcp-toolbox
    hostname: toolbox
    ports:
      - "6005:5000"
    volumes:
      - ./config/tools.yaml:/config/tools.yaml # Needs config file
    command: ["toolbox", "--tools-file", "/config/tools.yaml", "--address", "0.0.0.0"]
    depends_on:
      db_postgres:
        condition: service_healthy
    networks:
      - finopti-net

  # Postgres for DB Toolbox
  db_postgres:
    image: postgres:16-alpine
    container_name: finopti-db-postgres
    hostname: db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
        - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - finopti-net

# ====================
# Volume Configuration
# ====================
volumes:
  postgres-data:
    name: finopti-postgres-data
  loki-data:
    name: finopti-loki-data
  grafana-data:
    name: finopti-grafana-data

# ====================
# Network Configuration
# ====================
networks:
  finopti-net:
    name: finopti-net
    driver: bridge
