version: '3.8'

# FinOptiAgents Platform - Docker Compose Configuration
# 
# This file orchestrates all services in the FinOptiAgents platform:
# - Etcd: Key-value store for APISIX
# - Apache APISIX: API Gateway for routing and observability
# - OPA: Open Policy Agent for RBAC
# - Orchestrator: Central hub for request routing
# - Sub-Agents: GCloud and Monitoring agents
# - MCP Servers: Mock servers for tool execution
# - Streamlit UI: Frontend interface

services:
  # ====================
  # Etcd - APISIX Backend
  # ====================
  etcd:
    image: bitnami/etcd:3.5
    container_name: finopti-etcd
    environment:
      ETCD_ENABLE_V2: "true"
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ADVERTISE_CLIENT_URLS: "http://etcd:2379"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
    ports:
      - "2379:2379"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Apache APISIX - API Gateway
  # ====================
  apisix:
    image: apache/apisix:3.7.0-debian
    container_name: finopti-apisix
    volumes:
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro
    ports:
      - "9080:9080"  # HTTP port
      - "9180:9180"  # Admin API
      - "9091:9091"  # Prometheus metrics
    networks:
      - finopti-net
    depends_on:
      etcd:
        condition: service_healthy
    environment:
      APISIX_STAND_ALONE: "false"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ====================
  # APISIX Dashboard (Optional)
  # ====================
  apisix-dashboard:
    image: apache/apisix-dashboard:3.0.1-alpine
    container_name: finopti-apisix-dashboard
    ports:
      - "9000:9000"
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      APISIX_LISTEN_HOST: "apisix"

  # ====================
  # APISIX Route Initializer
  # ====================
  apisix-init:
    image: curlimages/curl:latest
    container_name: finopti-apisix-init
    volumes:
      - ./apisix_conf/init_routes.sh:/init_routes.sh:ro
    networks:
      - finopti-net
    depends_on:
      apisix:
        condition: service_healthy
    command: sh /init_routes.sh
    restart: "no"

  # ====================
  # OPA - Open Policy Agent
  # ====================
  opa:
    image: openpolicyagent/opa:latest
    container_name: finopti-opa
    volumes:
      - ./opa_policy:/policies:ro
    ports:
      - "8181:8181"
    networks:
      - finopti-net
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "/policies"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Orchestrator Agent
  # ====================
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: finopti-orchestrator
    ports:
      - "5000:5000"
    networks:
      - finopti-net
    depends_on:
      - opa
      - apisix
    environment:
      OPA_URL: "http://opa:8181"
      APISIX_URL: "http://apisix:9080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # GCloud Agent
  # ====================
  gcloud_agent:
    build:
      context: ./sub_agents/gcloud_agent
      dockerfile: Dockerfile
    container_name: finopti-gcloud-agent
    ports:
      - "5001:5001"
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      APISIX_URL: "http://apisix:9080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Monitoring Agent
  # ====================
  monitoring_agent:
    build:
      context: ./sub_agents/monitoring_agent
      dockerfile: Dockerfile
    container_name: finopti-monitoring-agent
    ports:
      - "5002:5002"
    networks:
      - finopti-net
    depends_on:
      - apisix
    environment:
      APISIX_URL: "http://apisix:9080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # GCloud MCP Server
  # ====================
  gcloud_mcp:
    build:
      context: ./mcp_servers/gcloud_mcp
      dockerfile: Dockerfile
    container_name: finopti-gcloud-mcp
    ports:
      - "6001:6001"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Monitoring MCP Server
  # ====================
  monitoring_mcp:
    build:
      context: ./mcp_servers/monitoring_mcp
      dockerfile: Dockerfile
    container_name: finopti-monitoring-mcp
    ports:
      - "6002:6002"
    networks:
      - finopti-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6002/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================
  # Streamlit UI
  # ====================
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: finopti-ui
    ports:
      - "8501:8501"
    networks:
      - finopti-net
    depends_on:
      - apisix
      - orchestrator
    environment:
      APISIX_URL: "http://apisix:9080"

# ====================
# Network Configuration
# ====================
networks:
  finopti-net:
    name: finopti-net
    driver: bridge
